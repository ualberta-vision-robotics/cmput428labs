---
layout: page
title: Lab 2.1 - 2D Projective Geometry and Homography Estimation
description:
permalink: /2dgeometry
img: 
importance: 1
category: Projective Geometry and Stereo
related_publications: false
---

<div class="row justify-content-md-center">
    <div class="col-sm-6 mt-6 mt-md-6">
        {% include figure.liquid loading="eager" path="assets/img/homography.gif" title="homography" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
<div class="caption">
    Homography transformations obtained from [<a href="https://towardsdatascience.com/understanding-transformations-in-computer-vision-b001f49a9e61" target="_blank">1</a>].
</div>

## Overview

In this lab you'll learn about 2D projective geometry and homography estimation.


__Important: You can obtain 3 bonus marks for each section you finish and demo while present during the lab period we introduce the lab.__

---

## 1. Homogeneous Transforms (20)
A transformatrion matrix, $$M$$, can be used to transform points in homogeneous form:

\begin{equation}
\left(\begin{array}{l}
\displaylines{x'\\\ y'\\\ 1}
\end{array}\right)
=
M
\left(\begin{array}{l}
\displaylines{x\\\ y\\\ 1}
\end{array}\right)
\end{equation}

We define scale, rotation and translation matricies in homogenenous coordinates as follows:

\begin{equation}
T=\left[\begin{array}{ccc}
\displaylines{
1 & 0 & t_x\\\ 
0 & 1 & t_y\\\ 
0 & 0 & 1
}
\end{array}\right]
\end{equation}

\begin{equation}
R=\left[\begin{array}{ccc}
\displaylines{
cos\theta & -sin\theta & 0\\\ 
sin\theta & cos\theta & 0\\\ 
0 & 0 & 1
}
\end{array}\right]
\end{equation}

\begin{equation}
S=\left[\begin{array}{ccc}
\displaylines{
s_x & 0 & 0\\\ 
0 & s_y & 0\\\ 
0 & 0 & 1
}
\end{array}\right]
\end{equation}

These matrices transform the homogeneous points with respect to the coordinate origin. They can be multiplied in any order and order of multiplication determines the order of the transformations performed on the points.

The following code loads the point cloud [happy.npy]({{"/assets/labs/happy.npy" | relative_url}}){:target="_blank"} and displays it in a 2d scatterplot. Use these points to complete question 1.

[happy.txt]({{"/assets/labs/happy.txt" | relative_url}}){:target="_blank"} is also available if you prefer.

```python
with open('happy.npy', 'rb') as f:
    happy_face = np.load(f, allow_pickle=True)

fig = plt.figure()
ax = fig.add_subplot()
plt.scatter(happy_face[0], happy_face[1], color='gray')
ax.set_aspect('equal', 'box')
plt.title("my face when I learn new things")
plt.show()
```

### a) 2D Homogeneous Transformations
- Create functions that create rotation, scale and translation transformation matricies. Use them to perform the following operations on the provided points.
  1. Translate the points 20 units along the Y-axis
  2. Rotate the points 30 degrees
  3. Uniformly scale the points by 0.8

**Deliverables:**
- Construct the system in full matrix form and display it in your report. Do not simplify.

**Report Question 1a:** How do our transformations change if we perform operations 1-3 with respect to the origin, instead of the point?

### b) Write a function that composes our homogeneous transformation matrix $$M = RTS$$.
- The function should take in a 1x2 translation vector, a 3x3 rotation matrix, and a 1x2 scale vector and returns the homogeneous transformation matrix M.
- Use your transformation matrix to apply three transformations of your choice to the provided points

**Deliverables:**
- Display the transformed points and what transformations you performed in your report.

**Report Question 1b:** What is one benefit of composing our transformations in homogeneous coordinates?

---

## 2. 2D Projective Geometry: Points, lines and their incidence (30)

### a) Hand Drawing

The homogeneous equation of a line is given as follows:
\begin{equation}
l^Tx=ax+by+c=0
\end{equation}
It holds true for all points that lie on the line.

The following three homogeneous lines display a simplified diagram of a railway track and the horizon.

$$
l_1=\left(\begin{array}{c}
-100 \\
1 \\
1
\end{array}\right) 
\quad l_2=\left(\begin{array}{c}
100 \\
1 \\
100
\end{array}\right), \quad l_H=\left(\begin{array}{c}
0 \\
1 \\
-100
\end{array}\right)
$$

Sketch the drawing labelling all three lines and the position of the vanishing point, the intersection of $$l_1$$ and $$l_2$$, given by $$l_1\times l_2$$.

**Deliverables:**
- Display the sketch in your report (you may use software to draw this sketch or scan a hand sketch).

### b) Construct the midpoint and midline of the football field in the image below.

<div class="row justify-content-md-center">
    <div class="col-sm-8 mt-6 mt-md-6">
        {% include figure.liquid loading="eager" path="assets/img/football_field.jpg" title="go alphonso davies!" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
<div class="caption">
    Save this image to use for question 2b.
</div>

1.  Click on the corners of the field using `matplotlib.pyplot.ginput` or your own mouse callback.
2.  Convert the points to homogeneous coordinates
3.  Compute the diagonal lines $$l_1$$ and $$l_2$$ (the line between two points is $$l=p_1\times p_2$$)
4.  Compute the midpoint, $$p_m$$ using the diagonal lines (the intersection between two lines is $$p=l_1\times l_2$$)
5.  Compute the vanishing point, $$p_\infty$$ as the intersection of the two short sides of the field
6.  Compute the midline using the vanishing point and the mid-point

**Deliverables:**
- Display the image with overlaid features in your report
- Save the image with overlaid features to include with your submissions

### c) Construct the midpoint and midline on a video sequence
- Place a book with a textured cover on a table and record a video
- Track the four corners of the book using 4 trackers, initialized by mouse clicks. You can use your own tracker or one of openCV's built in trackers (KCF or MOSSE are good)
- Use the tracked positions to draw the midline and midpoint on the book

**Deliverables:**
- Save the video with overlaid features to include with your submission.

**Report Question 2b:** What could be one real life use of this process?

### d) Line-to-line constraint

<div class="row justify-content-sm-center">
    <div class="col-sm-6 mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/parl_1.png" title="Line to Line 1" class="img-fluid rounded z-depth-1" %}
    </div>
    <div class="col-sm-6 mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/parl_2.png" title="Line to Line 2" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
<div class="caption">
    Line to line constraint for robot visual servoing.
</div>

\begin{equation}
e_{l2l} = y_1 \cdot (y_3 \times y_4) + y_2 \cdot (y_3 \times y_4)
\end{equation}

- Record a video of two books - rotate and move one of the books while leaving the other still.
- Track the appropriate points to construct the line to line constraint
- Overlay the value of the constraint onto the video.
- Optional: normalize the points and lines before computing the constraints to avoid overly large numbers.

**Deliverables:**
- Save the video with overlaid features to include with your submission.

**Report Question 2c:** What happens to the value of our constraint when we bring one line to the other?

### e) Parallel lines constraint

<div class="row justify-content-sm-center">
    <div class="col-sm-6 mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/l2l_1.png" title="Parallel lines 1" class="img-fluid rounded z-depth-1" %}
    </div>
    <div class="col-sm-6 mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/l2l_2.png" title="Parallel lines 2" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
<div class="caption">
    Parallel lines constraint for robot visual servoing.
</div>
The equation for the line to line constraint is:

\begin{equation}
e_{par} = (l_1 \times l_2) \times (l_3 \times l_4)
\end{equation}


- Use the same video but repeat with the parallel lines constraint
- This time our constraint is vector valued. Verify that its magnitude decreases when the books are near parallel, and its sign changes when the books cross the point of being parallel.

**Deliverables:**
- Save the video with overlaid features to include with your submission.

---

## 3. Homography Estimation (50)

<div class="row justify-content-sm-center">
    <div class="col-sm-4 mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/key1.jpg" title="keyboard view 1" class="img-fluid rounded z-depth-1" %}
    </div>
    <div class="col-sm-4 mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/key2.jpg" title="keyboard view 2" class="img-fluid rounded z-depth-1" %}
    </div>
    <div class="col-sm-4 mt-3 mt-md-0">
        {% include figure.liquid path="assets/img/key3.jpg" title="keyboard view 3" class="img-fluid rounded z-depth-1" %}
    </div>
</div>
<div class="caption">
    Sample images for question 3.
</div>

- See page 39-49 of [these slides](https://ugweb.cs.ualberta.ca/~vis/courses/CompVis/lectures18/lec06ProjG2D.pdf)

### a) Basic DLT Function
- Write a function `get_homography(x_1, x_2, normalization=False)` that returns the homography matrix, `H`, between two images, given the 4 (or more) point correspondences, `x_1` and `x_2` between two images.
- Apply your transformation to the first image to verify your results.
- Get the point correspondences through clicking on the same four features in two different images.

**Deliverables:**
- Display the two original images and the transformed image in your report.

**Report Question 3a:** What could be one real life use of this process?

### b) Normalization
- Implement a normalization procedure into your algorithm. Translate the points such that their mean is centred at the origin. Scale the points such that the average euclidean distance to the origin is $$\sqrt 2$$.
- Graduate students: use principal component analysis to center the points and normalize the variances in different principal axes to unity. 
- Explore performance of your algorithm with your own pictures.

**Deliverables:**
- Using your own images, display the two originals and the transformed image in your report.


**Report Question 3b**
- After the homography is applied, do the overlapping areas in the two images look exactly the same? Why / why not?
- Correspondences are not always perfect. What happens if some of the correspondences are incorrect? How can this be handled?

<!-- - This method is being used to align two images of a planar surface. Can it be used to align images of non-planar objects? What conditions need to be met?
- What if we only have four or more corresponding pairs of lines, instead of points? Or some pairs of points and some pairs of lines? Will the algorithm still work (under obvious modifications)? -->

---

## 4. Bonus (30) Live - Augmented Reality
- Track 4 points on a textured planar surface (e.g. poster, book cover) in a live video.
- Compute the homography in real time.
- Project an image onto the surface in the video. Move the camera and verify that the projection stays fixed.

**Deliverables:**
- Display an image of the projection original images and the transformed image in your report.

**Report Question 2b:** What could be one real life use of this process?

---

## Submission Details

- Include accompanying code used to complete each question. Ensure they are adequately commented.
- Ensure all functions are and sections are clearly labeled in your report to match the tasks and deliverables outlined in the lab.
- Organize files as follows:
  - `code/` folder containing all scripts used in the assignment.
  - `media/` folder for images, videos, and results.
- Final submission format: a single zip file named `CompVisW25_lab2.1_lastname_firstname.zip` containing the above structure.
- Your combined report for Lab 2.1 and 2.2 is due shortly after (see calendar for details). The report contains all media, results, and answers as specified in the instructions above. Ensure your answers are concise and directly address the questions.
- Total marks for this lab is __100__ for all students. Your lab assignment grade with bonus marks is capped at __130%__. Report bonus marks will be applied to the report grade, also capped at 110%.
